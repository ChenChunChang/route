define(function(t,e,n){"use strict";var i=t("riot-observable");var r=/^.+?\/+[^\/]+/,f="EventListener",o="remove"+f,s="add"+f,u="hasAttribute",c="replace",a="popstate",h="trigger",l=typeof window!="undefined"&&window,p=l&&document,d=l&&history,v=l&&(d.location||l.location),m=N.prototype,w=p&&p.ontouchstart?"touchstart":"click",b=false,g=i(),y,$,x,A;function E(t){return(t||"").split(/[\/?#]/)}function K(t,e){var n=new RegExp("^"+e[c](/\*/g,"([^/?#]+?)")[c](/\.\./,".*")+"$"),i=t.match(n);if(i)return i.slice(1)}function N(){this.$=[];i(this);g.on("stop",this.s.bind(this));g.on("emit",this.e.bind(this))}function R(t){return(t||"")[c](/^\/|\/$/,"")}function k(t){return(t||v.href||"")[c](r,"")}function q(t){return y[0]=="#"?(t||v.href||"").split(y)[1]||t:(k(t)||t||"")[c](new RegExp("^"+y),"")}function D(t,e){t=q(t);if(e||t!=$){g[h]("emit",t);$=t}}function L(){D()}function O(t){if(t.which!=1||t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;var e=t.target;while(e&&e.nodeName!="A")e=e.parentNode;if(!e||e.nodeName!="A"||e[u]("download")||!e[u]("href")||e.target&&e.target!="_self"||e.href.indexOf(v.href.match(r)[0])==-1)return;if(e.href!=v.href){if(e.href.split("#")[0]==v.href.split("#")[0])return;P(q(e.href),e.title||p.title)}t.preventDefault()}function P(t,e){e=e||p.title;d&&d.pushState(null,e,y+t);p.title=e;D(t)}m.m=function(t,e){if(t[0]&&(!e||e[0]))P(t,e);else if(e)this.r(t,e);else this.r("@",t)};m.s=function(){this.off("*");this.$=[]};m.e=function(t){this.$.concat("@").some(function(e){var n=(e=="@"?x:A)(R(t),R(e));if(n){this[h].apply(null,[e].concat(n));return true}},this)};m.r=function(t,e){if(t!="@")this.$.push(t);this.on(t,e)};var S=new N;var _=S.m.bind(S);_.create=function(){var t=new N;t.m.stop=t.s.bind(t);return t.m.bind(t)};_.base=function(t){y=t||"#";$=q()};_.exec=function(t){D(t,true)};_.parser=function(t,e){if(!t&&!e){x=E;A=K}if(t)x=t;if(e)A=e};_.query=function(){var t={};var e=v.href||$;e[c](/[?&](.+?)=([^&]*)/g,function(e,n,i){t[n]=i});return t};_.stop=function(){if(b){if(l){l[o](a,L);p[o](w,O)}g[h]("stop");b=false}};_.start=function(){if(!b){if(l){l[s](a,L);p[s](w,O)}b=true}};_.base();_.parser();n.exports=_});